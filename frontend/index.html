<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Layer Bridge</title>
    <link rel="stylesheet" href="main.css" />
    <link rel="icon" type="image/x-icon" href="/drkgrnswsh.png">

    <script>
      if (typeof crypto.randomUUID !== 'function') {
        crypto.randomUUID = function() {
          return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
          );
        };
      }
    </script>
  </head>

  <body>
    <header>
      <div class="top-right">
      </div>
      <h1 style="display: grid; grid-template-columns: auto auto; gap: 5px; align-items: center; justify-content: center; margin: 0; padding: 20px 0 0 0;">
        <img src="circle_logo.png" alt="Circle Logo" style="width: 40px; height: 40px; object-fit: contain; display: block;">
        <span style="display: block;">TRB Bridge To Tellor Layer</span>
      </h1>
      <div class="disclaimer">*Sepolia Test Network Only*</div>
    </header>
    <div class="box-wrapper">
      <w3m-button></w3m-button>
      <button id="walletButton" class="button-style-2" disabled>Connect Wallet</button>
      <div class="balance-info">
        <p class="info-text">(Current Balance: <span id="currentBalance">0 TRB</span>)</p>
        <p class="info-text">(Deposit limit: <span id="depositLimit"></span>)</p>
      </div>          
        <div class="input-button-container">
          <div class="input-with-label">
            <span class="input-label">TRB</span>
            <input class="input" type="text" id="stakeAmount" placeholder="0" />
          </div>
        </div>

        <div class="input-button-container">
          <div class="input-with-label">
            <input class="input-address" type="text" id="_queryId" placeholder="To address (e.g. tellor1py3fs... or 0x...)" />
            <span class="info-icon" data-tooltip="For deposits: Enter your Tellor Layer address (tellor1...). For withdrawals: Enter your Ethereum address (0x...)">â“˜</span>
          </div>
        </div>

        <div class="bridge-direction">
          <button id="approveButton" class="button-style-1" onclick="App.approveDeposit()">Approve Deposit</button>
            <button id="depositButton" class="button-style-3" onclick="App.depositToLayer()">Bridge to Layer</button>
          <button id="withdrawButton" class="button-style-3" onclick="App.withdrawFromLayer()">Bridge to Ethereum</button>
        </div>

        <a target="_blank" href="https://github.com/tellor-io/frontend-layerbridgebutton">Front-End code</a>
        <w3m-button></w3m-button>
    </div>
    <p style= "text-align: center"></p>
      <footer>

      </footer>
    </div>
    <script src="./extensions/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <script>
      // Define a global variable to track CosmJS loading
      window.cosmjsLoaded = false;
      
      // Function to load a single script
      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = src;
          script.onload = resolve;
          script.onerror = () => reject(new Error(`Failed to load ${src}`));
          document.head.appendChild(script);
        });
      }
      
      // Function to load CosmJS scripts
      async function loadCosmJS() {
        try {
          const scripts = [
            './extensions/cosmjs/encoding.js',
            './extensions/cosmjs/math.js',
            './extensions/cosmjs/proto.js',
            './extensions/cosmjs/proto-signing.js',
            './extensions/cosmjs/stargate.js'
          ];

          // Load scripts sequentially
          for (const src of scripts) {
            await loadScript(src);
          }

          // Verify CosmJS is loaded
          if (typeof window.cosmjs === 'undefined' || typeof window.cosmjs.stargate === 'undefined') {
            throw new Error('CosmJS failed to initialize properly');
          }

          window.cosmjsLoaded = true;
          return true;
        } catch (error) {
          console.error('Error loading CosmJS:', error);
          return false;
        }
      }

      // Load CosmJS and then initialize the app
      loadCosmJS()
        .then(success => {
          if (!success) {
            throw new Error('Failed to load CosmJS');
          }
          
          // Load app.js after CosmJS is loaded
          return loadScript('app.js');
        })
        .then(() => {
          // Initialize the app after everything is loaded
          if (typeof App !== 'undefined') {
            return App.init();
          }
          throw new Error('App not defined');
        })
        .catch(error => {
          console.error('Initialization error:', error);
          const walletButton = document.getElementById('walletButton');
          if (walletButton) {
            walletButton.textContent = 'Error: Please refresh page';
            walletButton.disabled = true;
          }
        });
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const infoIcons = document.querySelectorAll('.info-icon');
        let tooltipTimer;
        
        infoIcons.forEach(icon => {
          const tooltip = document.createElement('div');
          tooltip.className = 'tooltip';
          tooltip.innerHTML = icon.getAttribute('data-tooltip');
          icon.appendChild(tooltip);
          
          icon.addEventListener('click', function(e) {
            e.stopPropagation();
            
            // Clear any existing timer
            clearTimeout(tooltipTimer);
            
            // Toggle tooltip visibility
            if (tooltip.style.display === 'block') {
              tooltip.style.display = 'none';
            } else {
              // Hide all other tooltips
              document.querySelectorAll('.tooltip').forEach(t => t.style.display = 'none');
              
              // Show this tooltip
              tooltip.style.display = 'block';
              
              // Set timer to hide tooltip after 3 seconds
              tooltipTimer = setTimeout(() => {
                tooltip.style.display = 'none';
              }, 3000);
            }
          });
        });
        
        document.addEventListener('click', function() {
          clearTimeout(tooltipTimer);
          document.querySelectorAll('.tooltip').forEach(tooltip => {
            tooltip.style.display = 'none';
          });
        });

        // Add event listeners for input fields
        const stakeAmountInput = document.getElementById('stakeAmount');

        stakeAmountInput.addEventListener('input', async function() {
          const amount = parseFloat(this.value) || 0;
          const approveButton = document.getElementById('approveButton');
          const depositButton = document.getElementById('depositButton');
          hideBalanceErrorPopup();
          
          if (amount > 0) {
            const hasBalance = await checkBalance(amount);
            if (!hasBalance) {
              approveButton.disabled = true;
              depositButton.disabled = true;
              return;
            }
          }
          
          checkAllowance();
        });

        async function checkAllowance() {
          const approveButton = document.getElementById('approveButton');
          const depositButton = document.getElementById('depositButton');
          const withdrawButton = document.getElementById('withdrawButton');
          const stakeAmount = parseFloat(stakeAmountInput.value) || 0;

          if (isNaN(stakeAmount) || stakeAmount <= 0) {
            approveButton.disabled = true;
            depositButton.disabled = true;
            withdrawButton.disabled = true;
            return;
          }

          // Handle Keplr wallet
          if (App.isKeplrConnected) {
            approveButton.style.display = 'none';
            depositButton.style.display = 'none';
            withdrawButton.disabled = false;
            return;
          }

          // Handle MetaMask wallet
          try {
            const allowance = await App.getAllowance();
            const stakeAmountWei = App.web3.utils.toWei(stakeAmount.toString(), 'ether');
            
            if (App.web3.utils.toBN(stakeAmountWei).gt(App.web3.utils.toBN(allowance))) {
              // Need approval - enable approve button, disable deposit button
              approveButton.disabled = false;
              depositButton.disabled = true;
            } else {
              // Already approved - disable approve button, enable deposit button
              approveButton.disabled = true;
              depositButton.disabled = false;
            }
          } catch (error) {
            console.error('Error checking allowance:', error);
            approveButton.disabled = true;
            depositButton.disabled = true;
          }
        }

        // Initial checks
        checkAllowance();
      });
    </script>
  </body>
</html>