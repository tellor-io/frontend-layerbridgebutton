<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tellor Hub - Space Station</title>
    <link rel="stylesheet" href="main.css" />
    <link rel="stylesheet" href="space-station.css" />
    <link rel="icon" type="image/x-icon" href="/drkgrnswsh.png">

    <!-- Load protobuf.js first -->
    <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.4/dist/protobuf.min.js"></script>

    <script>
      if (typeof crypto.randomUUID !== 'function') {
        crypto.randomUUID = function() {
          return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
          );
        };
      }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Removed CryptoJS to avoid hosting security flags -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script> -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>
  </head>

  <body>
    <header>
      <div class="top-right">
        <!-- Wallet Manager Dropdown -->
        <div class="wallet-manager-dropdown">
          <button id="walletManagerToggle" class="wallet-manager-toggle">
            <span class="wallet-manager-text">Connect Wallets</span>
            <span class="wallet-manager-arrow">‚ñº</span>
          </button>
          <div id="walletManagerContent" class="wallet-manager-content">
            <button class="wallet-manager-close" id="walletManagerClose">√ó</button>
            <!-- Ethereum Wallet Section -->
            <div class="wallet-section">
              <h4 class="wallet-section-title">Ethereum Wallet</h4>
              <div class="wallet-group">
                <button id="walletButton" class="button-style-1" disabled>Connect Ethereum Wallet</button>
                <p class="wallet-balance" id="currentBalance">Balance: 0 TRB</p>
              </div>
              <!-- Network Display and Toggle -->
              <div class="network-group" style="display: none;">
                <span class="network-display" id="network-display">*Connect Wallet to Start*</span>
                <button id="network-toggle-btn" class="toggle-button" style="display: none;">
                  <span id="toggle-text">Switch to Mainnet</span>
                  <span class="toggle-icon">‚Üª</span>
                </button>
              </div>
            </div>
            
            <!-- Cosmos Wallet Section -->
            <div class="wallet-section">
              <h4 class="wallet-section-title">Cosmos Wallet</h4>
              <div class="wallet-group">
                <button id="keplrButton" class="button-style-2" disabled>Connect Cosmos Wallet</button>
                <p class="wallet-balance" id="ethKeplrBalance">Balance: 0 TRB</p>
              </div>
              <!-- Cosmos Network Display and Toggle -->
              <div class="network-group" style="display: none;">
                <span class="network-display" id="cosmos-network-display">*Connect Cosmos Wallet to Start*</span>
                <button id="cosmos-network-toggle-btn" class="toggle-button" style="display: none;">
                  <span id="cosmos-toggle-text">Switch to Mainnet</span>
                  <span class="toggle-icon">‚Üª</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </header>

    <!-- Space Station Hub Container -->
    <div class="space-station-container" id="spaceStationContainer">
      <!-- Initial Hub State -->
      <div class="hub-only-state" id="hubOnlyState">
        <!-- Central Hub -->
        <div class="central-hub">
                  <div class="hub-core">
          <img src="tellor_hub.png" alt="Tellor Hub" class="hub-logo">
        </div>
        </div>

        <!-- Orbiting Pods -->
        <div class="orbit-container">
          <!-- One Continuous Diagonal Line -->
          <div class="spoke-line spoke-diagonal"></div>
          
          <!-- Bridge to Layer Pod -->
          <div class="orbiting-pod" data-function="bridgeToLayer">
            <div class="pod-content">
              <img src="finales_bridge_tellor.png" alt="Bridge to Layer" class="pod-icon">
            </div>
          </div>

          <!-- Bridge to Ethereum Pod -->
          <div class="orbiting-pod" data-function="bridgeToEth">
            <div class="pod-content">
              <img src="finales_bridge_eth.png" alt="Bridge to Ethereum" class="pod-icon">
            </div>
          </div>

          <!-- Delegate Pod -->
          <div class="orbiting-pod" data-function="delegate">
            <div class="pod-content">
              <img src="finales_delegate.png" alt="Delegate" class="pod-icon">
            </div>
          </div>

          <!-- No-Stake Report Pod -->
          <div class="orbiting-pod" data-function="noStakeReport">
            <div class="pod-content">
              <img src="finales_report.png" alt="Report" class="pod-icon">
            </div>
          </div>
        </div>
      </div>

      <!-- Function Focus State -->
      <div class="function-focus-state" id="functionFocusState" style="display: none;">
        <!-- Side Navigation Menu -->
        <div class="side-nav-menu">
          <div class="side-nav-header">
            <button class="back-to-hub-btn" id="backToHubBtn">
              <span class="back-icon">‚Üê</span>
              <span class="back-text">Back to Hub</span>
            </button>
          </div>
          
          <div class="side-nav-options">
            <div class="nav-option" data-function="bridgeToLayer">
              <div class="nav-option-icon">üåâ</div>
              <div class="nav-option-title">Bridge to Tellor</div>
            </div>
            
            <div class="nav-option" data-function="bridgeToEth">
              <div class="nav-option-icon">üîó</div>
              <div class="nav-option-title">Bridge to Ethereum</div>
            </div>
            
            <div class="nav-option" data-function="delegate">
              <div class="nav-option-icon">‚ö°</div>
              <div class="nav-option-title">Delegate Tokens</div>
            </div>
            
            <div class="nav-option" data-function="noStakeReport">
              <div class="nav-option-icon">üìä</div>
              <div class="nav-option-title">No-Stake Report</div>
            </div>
          </div>
        </div>

        <!-- Function Display Area -->
        <div class="function-display-area">
          <div class="function-container">
            <!-- Bridge to Layer Section -->
            <div id="bridgeToLayerSection" class="function-section">
              <div class="section-header">
                <h2>üåâ Bridge to Tellor Layer</h2>
                <p class="section-description">Transfer your TRB tokens from Ethereum to the Tellor Layer</p>
              </div>
              <div class="wallet-disclaimer">*Please connect your Ethereum wallet to bridge tokens*</div>
              <w3m-button></w3m-button>
              <div class="balance-info">
                <div class="input-button-container">
                  <div class="input-with-label">
                    <span class="input-label">TRB</span>
                    <input class="input" type="text" id="stakeAmount" placeholder="0" />
                  </div>
                </div>
                <div class="Deposit-limit">
                  <p class="info-text">(Deposit limit: <span id="depositLimit"></span>)</p>
                </div>
                <div class="input-button-container">
                  <div class="input-with-label">
                    <input class="input-address" type="text" id="_queryId" placeholder="To address (e.g. tellor1py3fs...)" />
                    <span class="info-icon" data-tooltip="Don't have a tellor prefix address? <a href='https://docs.tellor.io/layer-docs/running-tellor-layer/node-setup' target='_blank'>Click here</a> to learn how to create one">‚ìò</span>
                  </div>
                </div>
                <div class="bridge-direction">
                  <button id="approveButton" class="button-style-1" onclick="App.approveDeposit()">Approve Deposit</button>
                  <button id="depositButton" class="button-style-3" onclick="App.depositToLayer()">Bridge to Layer</button>
                </div>
              </div>
            </div>

            <!-- Bridge to Ethereum Section -->
            <div id="bridgeToEthSection" class="function-section">
              <div class="section-header">
                <h2>üîó Bridge to Ethereum</h2>
                <p class="section-description">Withdraw your TRB tokens from Tellor Layer back to Ethereum</p>
              </div>
              <div class="wallet-disclaimer">*Please connect both wallets to bridge to Ethereum*</div>
              <div class="wallet-connection-container">
              </div>
              <div class="balance-info">
                  <div class="input-button-container">
                      <div class="input-with-label">
                          <span class="input-label">TRB</span>
                          <input class="input" type="text" id="ethStakeAmount" placeholder="0" />
                      </div>
                  </div>
                  <div class="input-button-container">
                      <div class="input-with-label">
                          <input class="input-address" type="text" id="ethQueryId" placeholder="To address (e.g. 0x...)" />
                          <span class="info-icon" data-tooltip="Enter your Ethereum address (0x...)">‚ìò</span>
                      </div>
                  </div>
                  <div class="bridge-direction">
                      <button id="withdrawButton" class="button-style-3" onclick="App.withdrawFromLayer()">1. Request Withdrawal</button>
                  </div>
              </div>
            </div>

            <!-- Delegate Section -->
            <div id="delegateSection" class="function-section">
              <div class="section-header">
                <h2>‚ö° Delegate Tokens</h2>
                <p class="section-description">Stake your TRB tokens with validators to earn rewards</p>
              </div>
              <div class="wallet-disclaimer">*Please connect your Cosmos wallet to delegate tokens*</div>
              <div class="wallet-connection-container">
              </div>
              <div class="balance-info">
                  <div class="input-button-container">
                      <div class="input-with-label">
                          <span class="input-label">TRB</span>
                          <input class="input" type="text" id="delegateStakeAmount" placeholder="0" />
                      </div>
                  </div>
                  <div class="input-button-container">
                      <div class="input-with-label">
                          <select class="input-address" id="delegateValidatorDropdown">
                              <option value="">Select a validator...</option>
                          </select>
                          <input type="hidden" id="delegateValidatorAddress" />
                          <button type="button" id="refreshValidatorsBtn" class="refresh-btn" title="Refresh validator list">‚Üª</button>
                          <span class="info-icon" data-tooltip="Select a validator from the list to delegate your tokens to">‚ìò</span>
                      </div>
                  </div>
                  <div class="bridge-direction">
                      <button id="delegateButton" class="button-style-3" onclick="App.delegateTokens()">Delegate Tokens</button>
                  </div>
              </div>
            </div>

            <!-- No-Stake Report Section -->
            <div id="noStakeReportSection" class="function-section">
              <div class="section-header">
                <h2>üìä No-Stake Report</h2>
                <p class="section-description">Submit data reports without requiring staked tokens</p>
              </div>
              <div class="wallet-disclaimer">*Please use the wallet manager above to connect your Cosmos wallet*</div>
              <div class="balance-info">
                  <div class="input-button-container full-width">
                      <div class="input-with-label no-stake-query-container">
                          <span class="input-label">Query Data (Hex)</span>
                          <textarea class="no-stake-input" id="noStakeQueryData" placeholder="0x..." rows="10"></textarea>
                      </div>
                  </div>
                  <div class="input-button-container full-width">
                      <div class="input-with-label no-stake-value-container">
                          <span class="input-label">Value (Hex)</span>
                          <input class="no-stake-input" type="text" id="noStakeValue" placeholder="0x..." />
                      </div>
                  </div>
                  <div class="bridge-direction">
                      <button id="submitNoStakeReportBtn" class="button-style-3" onclick="App.submitNoStakeReport()">Submit Report</button>
                  </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <a target="_blank" href="https://github.com/tellor-io/frontend-layerbridgebutton" class="frontend-code-link">Front-End code</a>
    
    <div id="bridgeTransactionsContainer" class="transactions-container">
      <div class="history-header">
        <h3>Withdrawal Transactions</h3>
        <div class="history-subtitle">View & Claim your withdrawal requests and their status</div>
      </div>
      <div class="withdrawal-table-container">
        <table id="withdrawal-history" class="withdrawal-table">
          <thead>
            <tr>
              <th>Actions</th>
              <th>ID</th>
              <th>Sender</th>
              <th>Recipient</th>
              <th class="amount-column">Amount (TRB)</th>
              <th>Time</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="7" class="loading-message">Waiting for wallet connections...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <script src="./extensions/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.10.0/web3.min.js"></script>
    <!-- Load app.js as a module only once -->
    <script type="module">
      // Define a global variable to track CosmJS loading
      window.cosmjsLoaded = false;
      
      // Function to load a single script
      function loadScript(src, type = 'text/javascript') {
        return new Promise((resolve, reject) => {
          // Skip if app.js is already loaded
          if (src === 'app.js' && document.querySelector('script[src="app.js"]')) {
            resolve();
            return;
          }
          const script = document.createElement('script');
          script.src = src;
          script.type = type;
          script.onload = () => {
            // For app.js, wait a tick to ensure App is defined
            if (src === 'app.js') {
              setTimeout(resolve, 0);
            } else {
              resolve();
            }
          };
          script.onerror = () => reject(new Error(`Failed to load ${src}`));
          document.head.appendChild(script);
        });
      }
      
      // Function to load CosmJS scripts
      async function loadCosmJS() {
        try {
          const scripts = [
            './extensions/cosmjs/encoding.js',
            './extensions/cosmjs/math.js',
            './extensions/cosmjs/proto.js',
            './extensions/cosmjs/proto-signing.js',
            './extensions/cosmjs/stargate.js'
          ];

          // Load scripts sequentially
          for (const src of scripts) {
            await loadScript(src);
          }

          // Verify CosmJS is loaded
          if (typeof window.cosmjs === 'undefined' || typeof window.cosmjs.stargate === 'undefined') {
            throw new Error('CosmJS failed to initialize properly');
          }

          window.cosmjsLoaded = true;
          return true;
        } catch (error) {
          console.error('Error loading CosmJS:', error);
          return false;
        }
      }

      // Function to load wallet adapter scripts
      async function loadWalletAdapters() {
        try {
          const scripts = [
            './js/walletAdapter.js',
            './js/walletModal.js',
            './js/ethereumWalletAdapter.js',
            './js/ethereumWalletModal.js'
          ];

          // Load scripts sequentially
          for (const src of scripts) {
            await loadScript(src);
          }

          // Verify wallet adapters are loaded
          if (typeof window.cosmosWalletAdapter === 'undefined') {
            console.warn('Cosmos wallet adapter not loaded - falling back to Keplr-only mode');
          }
          
          if (typeof window.ethereumWalletAdapter === 'undefined') {
            console.warn('Ethereum wallet adapter not loaded - falling back to MetaMask-only mode');
          }

          return true;
        } catch (error) {
          console.error('Error loading wallet adapters:', error);
          return false;
        }
      }

      // Load CosmJS and wallet adapters, then initialize the app
      Promise.all([
        loadCosmJS(),
        loadWalletAdapters()
      ])
        .then(([cosmjsSuccess, adapterSuccess]) => {
          if (!cosmjsSuccess) {
            throw new Error('Failed to load CosmJS');
          }
          
          // Load app.js as a module
          return loadScript('app.js', 'module');
        })
        .then(() => {
          // Wait for App to be defined
          return new Promise((resolve) => {
            const checkApp = () => {
              if (typeof window.App !== 'undefined') {
                resolve();
              } else {
                setTimeout(checkApp, 100);
              }
            };
            checkApp();
          });
        })
        .then(() => {
          // Initialize the app after everything is loaded
          return window.App.init();
        })
        .catch(error => {
          console.error('Initialization error:', error);
          const walletButton = document.getElementById('walletButton');
          if (walletButton) {
            walletButton.textContent = 'Error: Please refresh page';
            walletButton.disabled = true;
          }
        });
    </script>
    <script>
      // Simple test to see if the button exists
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - testing wallet manager button...');
        const testButton = document.getElementById('walletManagerToggle');
        console.log('Wallet manager button found:', !!testButton);
        if (testButton) {
          console.log('Button text:', testButton.textContent);
          testButton.addEventListener('click', function() {
            console.log('Button clicked via DOMContentLoaded handler');
          });
        }
      });
      
      document.addEventListener('DOMContentLoaded', function() {
        const infoIcons = document.querySelectorAll('.info-icon');
        let tooltipTimer;
        
        // Function to hide all tooltips
        function hideAllTooltips() {
            clearTimeout(tooltipTimer);
            document.querySelectorAll('.tooltip').forEach(tooltip => {
                tooltip.style.display = 'none';
            });
        }
        
        // Add pod navigation handlers
        const orbitingPods = document.querySelectorAll('.orbiting-pod');
        const orbitContainer = document.querySelector('.orbit-container');
        
        orbitingPods.forEach(pod => {
          // Add hover events to pause/resume space station
          pod.addEventListener('mouseenter', function() {
            orbitContainer.classList.add('paused');
          });
          
          pod.addEventListener('mouseleave', function() {
            orbitContainer.classList.remove('paused');
          });
          
          pod.addEventListener('click', function() {
            const functionType = this.getAttribute('data-function');
            
            // Switch to function focus state
            document.getElementById('hubOnlyState').style.display = 'none';
            document.getElementById('functionFocusState').style.display = 'flex';
            
            // Show corresponding section
            let sectionId = '';
            switch(functionType) {
              case 'bridgeToLayer':
                sectionId = 'bridgeToLayerSection';
                break;
              case 'bridgeToEth':
                sectionId = 'bridgeToEthSection';
                break;
              case 'delegate':
                sectionId = 'delegateSection';
                break;
              case 'noStakeReport':
                sectionId = 'noStakeReportSection';
                break;
            }
            
            if (sectionId) {
              document.querySelectorAll('.function-section').forEach(s => s.classList.remove('active'));
              document.getElementById(sectionId).classList.add('active');
            }
            
            // Update side nav active state
            document.querySelectorAll('.nav-option').forEach(opt => opt.classList.remove('active'));
            document.querySelector(`.nav-option[data-function="${functionType}"]`).classList.add('active');
            
            // Hide all tooltips when switching functions
            hideAllTooltips();
          });
        });
        
        // Add back to hub button handler
        document.getElementById('backToHubBtn').addEventListener('click', function() {
          document.getElementById('hubOnlyState').style.display = 'flex';
          document.getElementById('functionFocusState').style.display = 'none';
          
          // Reset all active states
          document.querySelectorAll('.orbiting-pod').forEach(p => p.classList.remove('active'));
          document.querySelectorAll('.function-section').forEach(s => s.classList.remove('active'));
          document.querySelectorAll('.nav-option').forEach(opt => opt.classList.remove('active'));
        });
        
        // Add side nav option handlers
        document.querySelectorAll('.nav-option').forEach(option => {
          option.addEventListener('click', function() {
            const functionType = this.getAttribute('data-function');
            
            // Update active nav option
            document.querySelectorAll('.nav-option').forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            
            // Show corresponding section
            let sectionId = '';
            switch(functionType) {
              case 'bridgeToLayer':
                sectionId = 'bridgeToLayerSection';
                break;
              case 'bridgeToEth':
                sectionId = 'bridgeToEthSection';
                break;
              case 'delegate':
                sectionId = 'delegateSection';
                break;
              case 'noStakeReport':
                sectionId = 'noStakeReportSection';
                break;
            }
            
            if (sectionId) {
              document.querySelectorAll('.function-section').forEach(s => s.classList.remove('active'));
              document.getElementById(sectionId).classList.add('active');
            }
            
            // Hide all tooltips when switching functions
            hideAllTooltips();
          });
        });
        
        infoIcons.forEach(icon => {
            // Add tooltip functionality to icons in the Bridge to Layer section and Delegate section
            if (icon.closest('#bridgeToLayerSection') || icon.closest('#delegateSection')) {
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.innerHTML = icon.getAttribute('data-tooltip');
                document.body.appendChild(tooltip);
                
                // Show tooltip on hover
                icon.addEventListener('mouseenter', function(e) {
                    // Only show tooltip if we're in the Bridge to Layer section or Delegate section
                    if (!document.getElementById('bridgeToLayerSection').classList.contains('active') && 
                        !document.getElementById('delegateSection').classList.contains('active')) {
                        return;
                    }
                    
                    e.stopPropagation();
                    clearTimeout(tooltipTimer);
                    
                    // Hide all other tooltips
                    hideAllTooltips();
                    
                    // Calculate position
                    const iconRect = icon.getBoundingClientRect();
                    const tooltipRect = tooltip.getBoundingClientRect();
                    
                    // Position tooltip to the right of the icon
                    let left = iconRect.right + 10;
                    let top = iconRect.top + (iconRect.height / 2) - (tooltipRect.height / 2);
                    
                    // Ensure tooltip stays within viewport
                    if (left + tooltipRect.width > window.innerWidth) {
                        left = iconRect.left - tooltipRect.width - 10;
                    }
                    if (top + tooltipRect.height > window.innerHeight) {
                        top = window.innerHeight - tooltipRect.height - 10;
                    }
                    if (top < 10) {
                        top = 10;
                    }
                    
                    // Apply position
                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                    tooltip.style.display = 'block';
                });
                
                // Hide tooltip when mouse leaves
                icon.addEventListener('mouseleave', function(e) {
                    e.stopPropagation();
                    tooltipTimer = setTimeout(() => {
                        tooltip.style.display = 'none';
                    }, 500);
                });
                
                // Also handle click for mobile devices
                icon.addEventListener('click', function(e) {
                    // Only show tooltip if we're in the Bridge to Layer section or Delegate section
                    if (!document.getElementById('bridgeToLayerSection').classList.contains('active') && 
                        !document.getElementById('delegateSection').classList.contains('active')) {
                        return;
                    }
                    
                    e.stopPropagation();
                    clearTimeout(tooltipTimer);
                    
                    // Calculate position for click
                    const iconRect = icon.getBoundingClientRect();
                    const tooltipRect = tooltip.getBoundingClientRect();
                    
                    let left = iconRect.right + 10;
                    let top = iconRect.top + (iconRect.height / 2) - (tooltipRect.height / 2);
                    
                    // Ensure tooltip stays within viewport
                    if (left + tooltipRect.width > window.innerWidth) {
                        left = iconRect.left - tooltipRect.width - 10;
                    }
                    if (top + tooltipRect.height > window.innerHeight) {
                        top = window.innerHeight - tooltipRect.height - 10;
                    }
                    if (top < 10) {
                        top = 10;
                    }
                    
                    // Toggle tooltip visibility
                    if (tooltip.style.display === 'block') {
                        tooltip.style.display = 'none';
                    } else {
                        // Hide all other tooltips
                        hideAllTooltips();
                        
                        // Show this tooltip
                        tooltip.style.left = left + 'px';
                        tooltip.style.top = top + 'px';
                        tooltip.style.display = 'block';
                        
                        // Set timer to hide tooltip after 3 seconds on mobile
                        tooltipTimer = setTimeout(() => {
                            tooltip.style.display = 'none';
                        }, 3000);
                    }
                });
            }
        });
        
        // Hide tooltips when clicking anywhere else
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.info-icon') && !e.target.closest('.tooltip')) {
                hideAllTooltips();
            }
        });

        // Update tooltip position on window resize
        window.addEventListener('resize', function() {
            document.querySelectorAll('.tooltip').forEach(tooltip => {
                if (tooltip.style.display === 'block') {
                    const icon = document.querySelector('.info-icon[data-tooltip="' + tooltip.innerHTML + '"]');
                    if (icon && (document.getElementById('bridgeToLayerSection').classList.contains('active') || 
                                document.getElementById('delegateSection').classList.contains('active'))) {
                        const iconRect = icon.getBoundingClientRect();
                        const tooltipRect = tooltip.getBoundingClientRect();
                        
                        let left = iconRect.right + 10;
                        let top = iconRect.top + (iconRect.height / 2) - (tooltipRect.height / 2);
                        
                        if (left + tooltipRect.width > window.innerWidth) {
                            left = iconRect.left - tooltipRect.width - 10;
                        }
                        if (top + tooltipRect.height > window.innerHeight) {
                            top = window.innerHeight - tooltipRect.height - 10;
                        }
                        if (top < 10) {
                            top = 10;
                        }
                        
                        tooltip.style.left = left + 'px';
                        tooltip.style.top = top + 'px';
                    } else {
                        tooltip.style.display = 'none';
                    }
                }
            });
        });

        // Add event listeners for input fields
        const stakeAmountInput = document.getElementById('stakeAmount');

        stakeAmountInput.addEventListener('input', async function() {
          const amount = parseFloat(this.value) || 0;
          const approveButton = document.getElementById('approveButton');
          const depositButton = document.getElementById('depositButton');
          
          // Check if App is available and has the function
          if (window.App && window.App.hideBalanceErrorPopup) {
            window.App.hideBalanceErrorPopup();
          }
          
          if (amount > 0) {
            const hasBalance = await checkBalance(amount);
            if (!hasBalance) {
              approveButton.disabled = true;
              depositButton.disabled = true;
              return;
            }
          }
          
          checkAllowance();
        });

        async function checkBalance(amount) {
          // Check if App is available and has the function
          if (window.App && window.App.checkBalance) {
            return await window.App.checkBalance(amount);
          }
          
          // Fallback implementation
          try {
            if (!window.App || !window.App.isConnected) {
              return false;
            }
            
            const balance = await window.App.contracts.Token.methods.balanceOf(window.App.account).call();
            const balanceInEther = window.App.web3.utils.fromWei(balance, 'ether');
            return parseFloat(balanceInEther) >= amount;
          } catch (error) {
            console.error('Error checking balance:', error);
            return false;
          }
        }

        async function checkAllowance() {
          const approveButton = document.getElementById('approveButton');
          const depositButton = document.getElementById('depositButton');
          const withdrawButton = document.getElementById('withdrawButton');
          const stakeAmount = parseFloat(stakeAmountInput.value) || 0;

          if (isNaN(stakeAmount) || stakeAmount <= 0) {
            approveButton.disabled = true;
            depositButton.disabled = true;
            withdrawButton.disabled = true;
            return;
          }

          // Handle Keplr wallet
          if (App.isKeplrConnected) {
            approveButton.style.display = 'none';
            depositButton.style.display = 'none';
            withdrawButton.disabled = false;
            return;
          }

          // Handle MetaMask wallet
          try {
            const allowance = await App.getAllowance();
            const stakeAmountWei = App.web3.utils.toWei(stakeAmount.toString(), 'ether');
            
            if (App.web3.utils.toBN(stakeAmountWei).gt(App.web3.utils.toBN(allowance))) {
              // Need approval - enable approve button, disable deposit button
              approveButton.disabled = false;
              depositButton.disabled = true;
            } else {
              // Already approved - disable approve button, enable deposit button
              approveButton.disabled = true;
              depositButton.disabled = false;
            }
          } catch (error) {
            console.error('Error checking allowance:', error);
            approveButton.disabled = true;
            depositButton.disabled = true;
          }
        }

        // Hide all tooltips function
        function hideAllTooltips() {
          document.querySelectorAll('.tooltip').forEach(tooltip => {
            tooltip.style.display = 'none';
          });
        }

        // Initial checks
        checkAllowance();

        // No-stake reporting is now integrated with the existing wallet manager
      });
    </script>
    <script src="./js/noStake.js"></script>
  </body>
</html>